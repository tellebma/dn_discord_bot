name: Release - Publication de Version

# Workflow pour crÃ©er des releases avec notes et assets
on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  create-release:
    name: CrÃ©ation de la Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      packages: write

    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Historique complet pour le changelog

      - name: ðŸ“¦ Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“š Installation et Build
        run: |
          npm ci
          npm run build

      - name: ðŸ“¦ CrÃ©ation de l'archive de release
        run: |
          mkdir -p release
          tar -czf release/divnum-discord-bot-${{ github.ref_name }}.tar.gz \
            dist/ \
            package*.json \
            README.fr.md \
            CHANGELOG.md \
            LICENSE
          
          # CrÃ©er une archive avec le code source complet
          tar -czf release/divnum-discord-bot-${{ github.ref_name }}-source.tar.gz \
            --exclude=node_modules \
            --exclude=.git \
            --exclude=dist \
            .

      - name: ðŸ“ GÃ©nÃ©ration des notes de release
        id: changelog
        run: |
          # Extraire la section du changelog pour cette version
          VERSION=$(echo ${{ github.ref_name }} | sed 's/v//')
          
          # CrÃ©er les notes de release
          cat > release-notes.md << 'EOF'
          ## ðŸŽ‰ Release ${{ github.ref_name }}
          
          ### ðŸ“¦ TÃ©lÃ©chargements
          
          - **Build compilÃ© :** `divnum-discord-bot-${{ github.ref_name }}.tar.gz`
          - **Code source :** `divnum-discord-bot-${{ github.ref_name }}-source.tar.gz`
          
          ### ðŸ³ Images Docker
          
          ```bash
          # GitHub Container Registry
          docker pull ghcr.io/${{ github.repository_owner }}/divnum-discord-bot:${{ github.ref_name }}
          docker pull ghcr.io/${{ github.repository_owner }}/divnum-discord-bot:latest
          
          # Docker Hub (si configurÃ©)
          docker pull ${{ secrets.DOCKER_HUB_USERNAME }}/divnum-discord-bot:${{ github.ref_name }}
          ```
          
          ### ðŸš€ DÃ©ploiement Rapide
          
          **Avec Docker Compose :**
          ```bash
          # CrÃ©er .env avec vos tokens
          docker-compose up -d
          ```
          
          ### ðŸ“‹ Changelog
          
          EOF
          
          # Ajouter le contenu du CHANGELOG si disponible
          if [ -f CHANGELOG.md ]; then
            sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | head -n -1 >> release-notes.md
          else
            echo "Voir CHANGELOG.md pour les dÃ©tails" >> release-notes.md
          fi

      - name: ðŸŽ‰ CrÃ©ation de la GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
          files: |
            release/*.tar.gz
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š RÃ©sumÃ© de la Release
        run: |
          echo "### ðŸŽ‰ Release ${{ github.ref_name }} CrÃ©Ã©e" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag :** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit :** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Fichiers publiÃ©s :**" >> $GITHUB_STEP_SUMMARY
          echo "- divnum-discord-bot-${{ github.ref_name }}.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "- divnum-discord-bot-${{ github.ref_name }}-source.tar.gz" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images Docker publiÃ©es :**" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/${{ github.repository_owner }}/divnum-discord-bot:${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/${{ github.repository_owner }}/divnum-discord-bot:latest" >> $GITHUB_STEP_SUMMARY
